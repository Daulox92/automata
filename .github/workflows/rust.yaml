name: Rust

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  INTEL_SGX_SDK: https://download.01.org/intel-sgx/sgx-linux/2.12/distro/ubuntu18.04-server/sgx_linux_x64_sdk_2.12.100.3.bin
  INTEL_SGX_SDK_INSTALL_PATH: /opt

jobs:
  format:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          components: rustfmt
      - uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check

  build:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Install Intel SGX SDK
        run: |
          curl -sSf ${INTEL_SGX_SDK} > /tmp/intel_sgx_sdk_installer
          chmod +x /tmp/intel_sgx_sdk_installer
          echo -e 'no\n${INTEL_SGX_SDK_INSTALL_PATH}' | /tmp/intel_sgx_sdk_installer
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          target: wasm32-unknown-unknown
      - uses: actions-rs/cargo@v1
        with:
          command: build
          args: --workspace

  test:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Install Intel SGX SDK
        run: |
          curl -sSf ${INTEL_SGX_SDK} > /tmp/intel_sgx_sdk_installer
          chmod +x /tmp/intel_sgx_sdk_installer
          echo -e 'no\n${INTEL_SGX_SDK_INSTALL_PATH}' | /tmp/intel_sgx_sdk_installer
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          target: wasm32-unknown-unknown
      - uses: actions-rs/cargo@v1
        with:
          command: test
          args: --workspace

  clippy:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
      - name: Install Intel SGX SDK
        run: |
          curl -sSf ${INTEL_SGX_SDK} > /tmp/intel_sgx_sdk_installer
          chmod +x /tmp/intel_sgx_sdk_installer
          echo -e 'no\n${INTEL_SGX_SDK_INSTALL_PATH}' | /tmp/intel_sgx_sdk_installer
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          components: clippy
          target: wasm32-unknown-unknown
      - uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --workspace -- -D warnings
